# Fluxos de Autentica√ß√£o e Autoriza√ß√£o - Tormenta20 TTRPGAPP

**Status da An√°lise**: ‚úÖ Completo
**Data**: 2025-10-25
**Arquivos Analisados**: AuthContext.tsx, UserContext.tsx, ProtectedRoute.tsx, Login/Register pages, API services, Supabase configs

---

## üìã √çndice

1. [Vis√£o Geral](#vis√£o-geral)
2. [Arquitetura de Autentica√ß√£o](#arquitetura-de-autentica√ß√£o)
3. [Fluxo de Registro (Sign Up)](#fluxo-de-registro-sign-up)
4. [Fluxo de Login (Sign In)](#fluxo-de-login-sign-in)
5. [Fluxo de Logout (Sign Out)](#fluxo-de-logout-sign-out)
6. [Sistema de Autoriza√ß√£o](#sistema-de-autoriza√ß√£o)
7. [Prote√ß√£o de Rotas](#prote√ß√£o-de-rotas)
8. [Seguran√ßa e RLS](#seguran√ßa-e-rls)
9. [Persist√™ncia de Sess√£o](#persist√™ncia-de-sess√£o)
10. [Fluxo Completo com Diagrama](#fluxo-completo-com-diagrama)

---

## Vis√£o Geral

O aplicativo utiliza **Supabase Auth** como sistema de autentica√ß√£o, com uma camada adicional de contextos React para gerenciar estado e autoriza√ß√£o baseada em roles (Player vs Game Master).

### Stack de Autentica√ß√£o

- **Provider**: Supabase Authentication
- **State Management**: React Context API (AuthContext + UserContext)
- **Route Protection**: ProtectedRoute HOC
- **Session Storage**: localStorage + Supabase session storage
- **Token Management**: Autom√°tico via Supabase (auto-refresh enabled)

---

## Arquitetura de Autentica√ß√£o

### Hierarquia de Contexts

```
App.tsx
‚îî‚îÄ‚îÄ AuthProvider (camada 1 - autentica√ß√£o base)
    ‚îî‚îÄ‚îÄ UserProvider (camada 2 - dados do usu√°rio + role)
        ‚îî‚îÄ‚îÄ CharacterProvider (camada 3 - dados do personagem)
            ‚îî‚îÄ‚îÄ Router + Routes
```

### Responsabilidades

| Context | Arquivo | Responsabilidade |
|---------|---------|------------------|
| **AuthContext** | `src/contexts/AuthContext.tsx` | Gerencia autentica√ß√£o Supabase (sign in/up/out), auth state |
| **UserContext** | `src/contexts/UserContext.tsx` | Carrega perfil do usu√°rio, determina role (Player/GM), gerencia personagens/jogos |
| **CharacterProvider** | `src/contexts/CharacterContext.tsx` | Gerencia estado completo do personagem selecionado |

---

## Fluxo de Registro (Sign Up)

### üìÑ Arquivo: `src/pages/auth/register/register.tsx`

### Campos do Formul√°rio

1. **Email** (obrigat√≥rio)
2. **Username** (obrigat√≥rio)
3. **Password** (m√≠nimo 6 caracteres)
4. **Confirm Password** (valida√ß√£o client-side)
5. **Role** (seletor):
   - `"player"` ‚Üí Jogador (padr√£o)
   - `"game-master"` ‚Üí Game Master

### Fluxo T√©cnico

```typescript
// 1. USER CLICA EM "REGISTER"
handleSubmit(e) {
  e.preventDefault();

  // 2. VALIDA√á√ïES CLIENT-SIDE
  if (password !== confirmPassword) return setError('Passwords do not match');
  if (password.length < 6) return setError('Password must be at least 6 characters');

  // 3. CHAMADA PARA AuthContext.signUp()
  const isGameMaster = role === 'game-master';
  const { error } = await signUp(email, password, username, isGameMaster);

  // 4. REDIRECIONAMENTO
  if (!error) {
    alert('Registration successful! Please check your email to verify your account.');
    navigate('/login');
  }
}
```

### AuthContext.signUp() - DUAL INSERT

```typescript
// Arquivo: src/contexts/AuthContext.tsx:62-91

async signUp(email, password, username, isGameMaster = false) {
  // PASSO 1: Criar usu√°rio na tabela auth.users (Supabase Auth)
  const { data, error } = await supabase.auth.signUp({
    email,
    password,
    options: {
      data: { username }  // Armazenado em auth.users.raw_user_meta_data
    }
  });

  if (error || !data.user) return { error };

  // PASSO 2: Criar registro na tabela public.users
  const { error: profileError } = await supabase
    .from('users')
    .insert([{
      id: data.user.id,              // MESMO UUID do auth.users
      username,
      email,
      is_game_master: isGameMaster   // ‚≠ê DETERMINA O ROLE
    }]);

  return { error: profileError };
}
```

### ‚ö†Ô∏è Importante: Verifica√ß√£o de Email

- Supabase **requer verifica√ß√£o de email** por padr√£o
- Usu√°rio recebe email com link de confirma√ß√£o
- Apenas ap√≥s confirma√ß√£o, pode fazer login
- Para desabilitar: Supabase Dashboard ‚Üí Authentication ‚Üí Email Auth ‚Üí "Confirm email" OFF

---

## Fluxo de Login (Sign In)

### üìÑ Arquivo: `src/pages/auth/login/login.tsx`

### Campos do Formul√°rio

1. **Email** (obrigat√≥rio)
2. **Password** (obrigat√≥rio)

### Fluxo T√©cnico

```typescript
// 1. USER CLICA EM "LOGIN"
handleSubmit(e) {
  e.preventDefault();

  // 2. CHAMADA PARA AuthContext.signIn()
  const { error } = await signIn(email, password);

  // 3. REDIRECIONAMENTO
  if (!error) {
    navigate('/');  // Home page (protegida)
  } else {
    setError(error.message);
  }
}
```

### AuthContext.signIn()

```typescript
// Arquivo: src/contexts/AuthContext.tsx:54-60

async signIn(email, password) {
  const { error } = await supabase.auth.signInWithPassword({
    email,
    password
  });
  return { error };
}
```

### Cascade de Efeitos Ap√≥s Login

```
1. signInWithPassword() ‚Üí sess√£o criada
         ‚Üì
2. onAuthStateChange() dispara (AuthContext.tsx:45)
         ‚Üì
3. setUser() e setSession() atualizados
         ‚Üì
4. UserContext detecta novo user (useEffect em UserContext.tsx:112)
         ‚Üì
5. fetchUserData() ‚Üí carrega dados da tabela users
         ‚Üì
6. Determina isGameMaster (UserContext.tsx:47)
         ‚Üì
7. Se Player ‚Üí fetchCharacters() (UserContext.tsx:82-94)
   Se GM ‚Üí fetchGames() (UserContext.tsx:97-109)
         ‚Üì
8. CharacterProvider carrega personagem selecionado (se existir)
         ‚Üì
9. Home page renderiza com dados completos
```

---

## Fluxo de Logout (Sign Out)

### AuthContext.signOut()

```typescript
// Arquivo: src/contexts/AuthContext.tsx:93-95

async signOut() {
  await supabase.auth.signOut();
}
```

### Cascade de Efeitos Ap√≥s Logout

```
1. signOut() ‚Üí sess√£o destru√≠da
         ‚Üì
2. onAuthStateChange() dispara com session = null
         ‚Üì
3. setUser(null) e setSession(null)
         ‚Üì
4. UserContext detecta user = null (UserContext.tsx:60-66)
         ‚Üì
5. setUserData(null), setCharacters([]), setGames([])
         ‚Üì
6. CharacterProvider limpa dados do personagem
         ‚Üì
7. ProtectedRoute detecta !user ‚Üí redirect para /login
```

---

## Sistema de Autoriza√ß√£o

### Player vs Game Master

O sistema tem **dois tipos de usu√°rios** com fluxos completamente diferentes:

| Tipo | Campo no DB | Home Page | Dados Carregados |
|------|-------------|-----------|------------------|
| **Player** | `is_game_master = false` | Lista de personagens | `characters[]` |
| **Game Master** | `is_game_master = true` | Lista de jogos | `games[]` |

### Implementa√ß√£o no UserContext

```typescript
// Arquivo: src/contexts/UserContext.tsx:42-47

const [userData, setUserData] = useState<User | null>(null);
const [characters, setCharacters] = useState<Character[]>([]);
const [games, setGames] = useState<Game[]>([]);

// ‚≠ê DERIVED STATE
const isGameMaster = userData?.isGameMaster ?? false;
```

### Renderiza√ß√£o Condicional

```typescript
// Arquivo: src/pages/home/home.tsx:46-130

return (
  <div className="home-container">
    <h1>{userData?.username || 'Usu√°rio'}</h1>

    {/* PLAYER VIEW */}
    {!isGameMaster && (
      <div className="characters-section">
        <h2>Seus Personagens</h2>
        <button onClick={handleCreateCharacter}>+ Novo Personagem</button>
        {characters.map(char => (
          <CharacterCard key={char.id} character={char} />
        ))}
      </div>
    )}

    {/* GAME MASTER VIEW */}
    {isGameMaster && (
      <div className="characters-section">
        <h2>Seus Jogos</h2>
        <button onClick={handleCreateGame}>+ Novo Jogo</button>
        {games.map(game => (
          <GameCard key={game.id} game={game} />
        ))}
      </div>
    )}
  </div>
);
```

### API Layer - Filtragem por User ID

```typescript
// Arquivo: src/services/api.ts:22-46

export const userApi = {
  async getCurrentUser() {
    // 1. Pega o auth user
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return null;

    // 2. Busca dados completos na tabela users
    const { data, error } = await supabase
      .from('users')
      .select('*')
      .eq('id', user.id)  // ‚≠ê FILTRA POR USER ID
      .single();

    if (error) throw error;

    // 3. Mapeia snake_case ‚Üí camelCase
    return {
      id: data.id,
      username: data.username,
      email: data.email,
      isGameMaster: data.is_game_master,  // ‚≠ê ROLE
      // ... outros campos
    } as User;
  }
}
```

---

## Prote√ß√£o de Rotas

### üìÑ Arquivo: `src/components/ProtectedRoute.tsx`

### Implementa√ß√£o

```typescript
const ProtectedRoute = ({ children }: ProtectedRouteProps) => {
  const { user, loading } = useAuth();

  // 1. ESTADO DE CARREGAMENTO
  if (loading) {
    return <div>Loading...</div>;
  }

  // 2. SEM AUTENTICA√á√ÉO ‚Üí REDIRECT
  if (!user) {
    return <Navigate to="/login" replace />;
  }

  // 3. AUTENTICADO ‚Üí RENDERIZA CONTE√öDO
  return <>{children}</>;
};
```

### Rotas Protegidas (App.tsx)

```typescript
<Routes>
  {/* ROTAS P√öBLICAS */}
  <Route path="/login" element={<Login />} />
  <Route path="/register" element={<Register />} />
  <Route path="/modal-example" element={<ModalExample />} />

  {/* ROTAS PROTEGIDAS */}
  <Route path="/" element={<ProtectedRoute><Home /></ProtectedRoute>} />
  <Route path="/profile/:characterId" element={<ProtectedRoute><Profile /></ProtectedRoute>} />
  <Route path="/notes" element={<ProtectedRoute><Notes /></ProtectedRoute>} />
  <Route path="/backstory" element={<ProtectedRoute><BackstoryPage /></ProtectedRoute>} />
  <Route path="/combat" element={<ProtectedRoute><Combat /></ProtectedRoute>} />
  <Route path="/skills" element={<ProtectedRoute><Skills /></ProtectedRoute>} />
  <Route path="/proficiencies" element={<ProtectedRoute><Proficiencies /></ProtectedRoute>} />
  <Route path="/group" element={<ProtectedRoute><Group /></ProtectedRoute>} />
  <Route path="/attributes" element={<ProtectedRoute><Attributes /></ProtectedRoute>} />
  <Route path="/create-character" element={<ProtectedRoute><CharacterCreation /></ProtectedRoute>} />
</Routes>
```

### Matriz de Acesso

| Rota | P√∫blico | Player | GM | Notas |
|------|---------|--------|-----|-------|
| `/login` | ‚úÖ | ‚úÖ | ‚úÖ | P√∫blico |
| `/register` | ‚úÖ | ‚úÖ | ‚úÖ | P√∫blico |
| `/` (Home) | ‚ùå | ‚úÖ | ‚úÖ | Renderiza√ß√£o diferente por role |
| `/profile/:characterId` | ‚ùå | ‚úÖ | ‚ö†Ô∏è | GMs n√£o t√™m personagens |
| `/create-character` | ‚ùå | ‚úÖ | ‚ö†Ô∏è | GMs n√£o criam personagens |
| Todas as outras | ‚ùå | ‚úÖ | ‚ö†Ô∏è | Fluxo focado em Players |

‚ö†Ô∏è **Observa√ß√£o**: Atualmente N√ÉO h√° valida√ß√£o de role nas rotas. Um GM pode tecnicamente acessar `/profile` se tiver um characterId, mas isso n√£o faz parte do fluxo normal.

---

## Seguran√ßa e RLS

### Status Atual

| Aspecto | Status | Detalhes |
|---------|--------|----------|
| **RLS Habilitado** | ‚ùå | Apenas `transactions` table |
| **Pol√≠ticas Definidas** | ‚úÖ | `supabase_rls_policies.sql` (357 linhas) |
| **Pol√≠ticas Aplicadas** | ‚ùå | **N√ÉO** aplicadas ao database |
| **Raz√£o** | üë• | Projeto entre amigos (decis√£o do usu√°rio) |

### Verifica√ß√£o de Seguran√ßa (via MCP Supabase)

```sql
-- Query executada: W:\rpg webapp\TTRPGAPP\docs-madeByAi\AUTHENTICATION_AUTHORIZATION_FLOWS.md

SELECT schemaname, tablename, policyname
FROM pg_policies
WHERE tablename IN ('users', 'characters', 'transactions');

-- RESULTADO (apenas 1 policy ativa):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ schemaname     ‚îÇ tablename        ‚îÇ policyname                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ public         ‚îÇ transactions     ‚îÇ Users can manage own character transactions ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### RLS Policy Implementada (transactions)

```sql
-- Arquivo: docs-madeByAi/supabase_transactions_table.sql

CREATE POLICY "Users can manage own character transactions"
ON transactions
FOR ALL
USING (
  EXISTS (
    SELECT 1
    FROM characters
    WHERE characters.id = transactions.character_id
      AND characters.user_id = auth.uid()
  )
);
```

### Pol√≠ticas Dispon√≠veis (N√ÉO aplicadas)

O arquivo `supabase_rls_policies.sql` cont√©m pol√≠ticas completas para:

- **users**: View/update/insert own profile
- **characters**: CRUD own characters
- **character_attributes**: Manage via character ownership
- **skills, proficiencies, notes**: Manage via character ownership
- **spells, abilities, items**: Read-only catalogs para todos
- **character_spells, character_items, attacks**: Manage via character ownership
- **games**: GMs manage own games, players view games they're in
- **game_players**: GMs manage, players view
- **game_sessions**: GMs manage, players view
- **groups**: Group members view/update
- **group_storage**: Group members manage

### Implica√ß√µes de Seguran√ßa

‚ö†Ô∏è **RISCO**: Sem RLS nas tabelas principais, qualquer usu√°rio autenticado pode:
- Ler TODOS os personagens de TODOS os usu√°rios
- Modificar personagens que n√£o s√£o seus
- Acessar dados de outros jogadores

‚úÖ **MITIGA√á√ÉO ATUAL**:
- Frontend usa `user.id` para filtrar queries (`.eq('user_id', userId)`)
- Confian√ßa entre amigos (projeto privado)
- Supabase anon key n√£o exposta publicamente

üîí **RECOMENDA√á√ÉO**: Se o projeto se tornar p√∫blico ou tiver usu√°rios n√£o confi√°veis, aplicar as pol√≠ticas RLS definidas.

---

## Persist√™ncia de Sess√£o

### Supabase Session Storage

```typescript
// Arquivo: src/config/supabase.ts:10-16

export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    autoRefreshToken: true,        // ‚≠ê Renova token automaticamente
    persistSession: true,           // ‚≠ê Salva sess√£o no localStorage
    detectSessionInUrl: true        // ‚≠ê Detecta sess√£o de magic links
  }
});
```

### localStorage - Selected Character

```typescript
// Arquivo: src/contexts/UserContext.tsx:42-56

const [selectedCharacterId, setSelectedCharacterId] = useState<string | null>(() => {
  // ‚≠ê INIT: Carrega do localStorage
  return localStorage.getItem('selectedCharacterId');
});

// ‚≠ê SYNC: Salva no localStorage quando muda
useEffect(() => {
  if (selectedCharacterId) {
    localStorage.setItem('selectedCharacterId', selectedCharacterId);
  } else {
    localStorage.removeItem('selectedCharacterId');
  }
}, [selectedCharacterId]);
```

### Comportamento de Persist√™ncia

| Cen√°rio | Sess√£o Auth | selectedCharacterId | Resultado |
|---------|-------------|---------------------|-----------|
| **Primeira visita** | ‚ùå | ‚ùå | Redirect ‚Üí `/login` |
| **Login bem-sucedido** | ‚úÖ | ‚ùå | Home ‚Üí lista de personagens |
| **Seleciona personagem** | ‚úÖ | ‚úÖ | Redirect ‚Üí `/profile/:id` |
| **Refresh da p√°gina** | ‚úÖ | ‚úÖ | Mant√©m personagem selecionado |
| **Fecha e reabre navegador** | ‚úÖ | ‚úÖ | Mant√©m autentica√ß√£o E personagem |
| **Logout** | ‚ùå | ‚úÖ (ainda no storage) | Redirect ‚Üí `/login`, personagem limpo no pr√≥ximo login |

---

## Fluxo Completo com Diagrama

### Fluxo Detalhado: Do Registro ao Personagem

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    FASE 1: REGISTRO                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

User ‚Üí Register Page
   ‚Üì
Preenche: email, username, password, role (player/game-master)
   ‚Üì
handleSubmit()
   ‚Üì
AuthContext.signUp(email, password, username, isGameMaster)
   ‚îú‚îÄ‚Üí 1. Cria user em auth.users (Supabase Auth)
   ‚îî‚îÄ‚Üí 2. Cria record em public.users (is_game_master: boolean)
   ‚Üì
Alert: "Check your email"
   ‚Üì
User ‚Üí Email ‚Üí Click verification link
   ‚Üì
Supabase confirma email
   ‚Üì
Redirect ‚Üí Login Page

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    FASE 2: LOGIN                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

User ‚Üí Login Page
   ‚Üì
Preenche: email, password
   ‚Üì
handleSubmit()
   ‚Üì
AuthContext.signIn(email, password)
   ‚Üì
supabase.auth.signInWithPassword() ‚Üí SESSION CRIADA
   ‚Üì
onAuthStateChange() DISPARA (AuthContext)
   ‚îú‚îÄ‚Üí setUser(session.user)
   ‚îî‚îÄ‚Üí setSession(session)
   ‚Üì
useEffect detecta user (UserContext:112)
   ‚Üì
fetchUserData()
   ‚îú‚îÄ‚Üí Query: SELECT * FROM users WHERE id = auth.uid()
   ‚îî‚îÄ‚Üí setUserData({ ..., isGameMaster: data.is_game_master })
   ‚Üì
useEffect detecta userData (UserContext:118)
   ‚Üì
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ IF isGameMaster = TRUE                        ‚îÇ
   ‚îÇ   ‚Üì                                           ‚îÇ
   ‚îÇ fetchGames()                                  ‚îÇ
   ‚îÇ   ‚Üì                                           ‚îÇ
   ‚îÇ Query: SELECT * FROM games                    ‚îÇ
   ‚îÇ        WHERE game_master_id = auth.uid()      ‚îÇ
   ‚îÇ   ‚Üì                                           ‚îÇ
   ‚îÇ setGames([...])                               ‚îÇ
   ‚îÇ   ‚Üì                                           ‚îÇ
   ‚îÇ RENDER: Home com lista de jogos               ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ IF isGameMaster = FALSE (PLAYER)              ‚îÇ
   ‚îÇ   ‚Üì                                           ‚îÇ
   ‚îÇ fetchCharacters()                             ‚îÇ
   ‚îÇ   ‚Üì                                           ‚îÇ
   ‚îÇ Query: SELECT * FROM characters               ‚îÇ
   ‚îÇ        WHERE user_id = auth.uid()             ‚îÇ
   ‚îÇ   ‚Üì                                           ‚îÇ
   ‚îÇ setCharacters([...])                          ‚îÇ
   ‚îÇ   ‚Üì                                           ‚îÇ
   ‚îÇ RENDER: Home com lista de personagens         ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ             FASE 3: SELE√á√ÉO DE PERSONAGEM                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

User ‚Üí Home Page ‚Üí Click em Character Card
   ‚Üì
handleCharacterClick(characterId)
   ‚îú‚îÄ‚Üí setSelectedCharacterId(characterId)
   ‚îÇ     ‚îî‚îÄ‚Üí localStorage.setItem('selectedCharacterId', characterId)
   ‚îî‚îÄ‚Üí navigate(`/profile/${characterId}`)
   ‚Üì
Profile Page monta
   ‚Üì
useEffect no Profile (profile.tsx:33)
   ‚îî‚îÄ‚Üí setSelectedCharacterId(characterId) [redundante, j√° setado]
   ‚Üì
CharacterContext detecta selectedCharacterId (CharacterContext.tsx)
   ‚Üì
loadCharacter(characterId)
   ‚Üì
Promise.all([
  loadInventory(characterId),
  loadTransactions(characterId),
  loadNotes(characterId),
  loadAttributes(characterId),
  loadSkills(characterId),
  loadAttacks(characterId),
  loadSpells(characterId),
  loadAbilities(characterId),
  loadPowers(characterId)
]) ‚Üí 9 queries em paralelo
   ‚Üì
Calcula current_load
   ‚Üì
setCharacter({ ...allData })
   ‚Üì
RENDER: Profile Page completa com todos os dados

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    FASE 4: PERSIST√äNCIA                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

User ‚Üí Refresh (F5)
   ‚Üì
App monta
   ‚Üì
AuthProvider monta
   ‚îú‚îÄ‚Üí supabase.auth.getSession() ‚Üí RECUPERA SESS√ÉO DO STORAGE
   ‚îî‚îÄ‚Üí setUser(session.user), setSession(session)
   ‚Üì
UserProvider monta
   ‚îú‚îÄ‚Üí Detecta user do AuthContext
   ‚îî‚îÄ‚Üí Repete FASE 2 (fetchUserData ‚Üí fetchCharacters/Games)
   ‚Üì
CharacterProvider monta
   ‚îú‚îÄ‚Üí selectedCharacterId carregado do localStorage
   ‚îî‚îÄ‚Üí Repete FASE 3 (loadCharacter)
   ‚Üì
RESULT: User permanece logado e no personagem selecionado

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    FASE 5: LOGOUT                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

User ‚Üí Click "Logout" (via Navbar ou Profile)
   ‚Üì
AuthContext.signOut()
   ‚Üì
supabase.auth.signOut() ‚Üí SESS√ÉO DESTRU√çDA
   ‚Üì
onAuthStateChange() DISPARA com session = null
   ‚îú‚îÄ‚Üí setUser(null)
   ‚îî‚îÄ‚Üí setSession(null)
   ‚Üì
UserContext detecta user = null (UserContext:60)
   ‚îú‚îÄ‚Üí setUserData(null)
   ‚îú‚îÄ‚Üí setCharacters([])
   ‚îî‚îÄ‚Üí setGames([])
   ‚Üì
CharacterContext limpa character state
   ‚Üì
ProtectedRoute detecta !user
   ‚Üì
<Navigate to="/login" replace />
   ‚Üì
User ‚Üí Login Page
```

---

## üîç Observa√ß√µes e Melhorias Potenciais

### ‚úÖ Pontos Fortes

1. **Separa√ß√£o de Responsabilidades**: AuthContext (auth) vs UserContext (dados)
2. **Persist√™ncia Robusta**: Session + selectedCharacterId
3. **Type Safety**: TypeScript em todos os contextos e APIs
4. **Auto-refresh**: Tokens renovados automaticamente
5. **Parallel Loading**: CharacterContext carrega dados em paralelo (Performance)

### ‚ö†Ô∏è Potenciais Melhorias

1. **Role-based Route Guards**: Adicionar verifica√ß√£o de `isGameMaster` no ProtectedRoute
   ```typescript
   <ProtectedRoute requireRole="player">
     <Profile />
   </ProtectedRoute>
   ```

2. **RLS Implementation**: Aplicar as pol√≠ticas definidas em `supabase_rls_policies.sql`

3. **Error Boundaries**: Adicionar error boundaries nos Providers para capturar erros de auth

4. **Loading States**: Melhorar UX dos estados de loading (skeleton screens)

5. **Password Reset**: Implementar fluxo de "Esqueci minha senha"

6. **OAuth Providers**: Adicionar login social (Google, Discord, etc.)

7. **2FA/MFA**: Supabase suporta TOTP, SMS, etc. (conforme advisory de seguran√ßa)

8. **Session Timeout**: Implementar logout autom√°tico ap√≥s inatividade

---

## üìä Estat√≠sticas do Sistema

| M√©trica | Valor |
|---------|-------|
| **Contexts de Auth** | 3 (Auth, User, Character) |
| **Rotas Protegidas** | 10 de 13 rotas |
| **Rotas P√∫blicas** | 3 (login, register, modal-example) |
| **Tabelas com RLS** | 1 de 25 (4%) |
| **Pol√≠ticas Definidas** | ~50 (em supabase_rls_policies.sql) |
| **Pol√≠ticas Aplicadas** | 1 (transactions) |
| **Auth Providers** | 1 (email/password) |
| **User Roles** | 2 (Player, Game Master) |

---

## üéØ Conclus√£o

O sistema de autentica√ß√£o e autoriza√ß√£o est√° **funcional e bem estruturado** para um projeto entre amigos. A arquitetura de contexts React √© s√≥lida e escal√°vel.

A principal lacuna √© a **falta de RLS nas tabelas**, que foi uma **decis√£o consciente do usu√°rio** para simplificar o projeto. Para um ambiente de produ√ß√£o com usu√°rios n√£o confi√°veis, seria essencial aplicar as pol√≠ticas RLS j√° definidas.

O fluxo de Player vs Game Master est√° bem implementado, com renderiza√ß√£o condicional baseada no campo `is_game_master` da tabela `users`.

---

**Documenta√ß√£o criada por**: Claude Code
**Task Archon**: cb654f29-048d-4938-bc3a-feaa9fc23114
**Status**: ‚úÖ An√°lise completa
